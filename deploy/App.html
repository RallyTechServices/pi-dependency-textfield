<!DOCTYPE html>
<html>
<head>
    <title>pi-dependency-textfield</title>
    <!--  (c) 2014 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Thu Apr 17 2014 07:23:16 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Thu Apr 17 2014 07:23:16 GMT-0600 (MDT)";
        var CHECKSUM = 40816122503;
    </script>
    
    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Ext.Component',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
     title: "Build Information",
    
    renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>--</div>",

    initComponent: function() {
        this.callParent(arguments);
       
    },
    
    onRender: function() {
        this.callParent(arguments);
        this.mon(this.el,'click',this.onClick,this);
    },
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
    
        return chk;
    },
    _checkChecksum: function(container) {
        var me = this;
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    if ( CHECKSUM !== me._generateChecksum(text) ) {
                        console.log("Checksums don't match!");
                        if ( me.dialog ) {
                            me.dialog.add({xtype:'container',html:'Checksums do not match'});
                        }
                    }
                }
            }
        });
    },
    onClick: function(e) {
        var me = this;
        this._checkChecksum(this);
        
        var dialog_items = [];
        
        if ( this.informationHtml ) {
            dialog_items.push({
                xtype:'container',
                html: this.informationHtml
            });
        }
                
        dialog_items.push({
            xtype:'container',
            html:"This app was created by the Rally Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            dialog_items.push({
                xtype:'container',
                html:'Build date/time: ' + APP_BUILD_DATE
            });
        }
        
        if (this.dialog){this.dialog.destroy();}
        this.dialog = Ext.create('Rally.ui.dialog.Dialog',{
            defaults: { padding: 5, margin: 5 },
            closable: true,
            draggable: true,
            title: me.title,
            items: dialog_items
        });
        this.dialog.show();
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});


Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    items:
        [
         {xtype:'container',itemId:'display_box', style:{padding: '10px'}}, 
         {xtype:'container',itemId:'portfolio_item_box', layout: {type: 'hbox'}, style:{padding: '10px'}},
         {xtype:'container',itemId:'relatives_box',flex:1, layout:{type: 'hbox'}, style: {padding: '10px'},
          	items:
          	[
          	    {
          	    	xtype: 'container', 
          	    	style: {padding: '20px'},
          	    	itemId: 'predecessor_box', 
         	    	flex: 1
          	    	
          	    },
          	    {
          	    	xtype: 'container', 
          	    	itemId: 'successor_box', 
          	    	style: {padding: '20px'},
          	    	flex: 1,
          	    }       	       
          	]
          },
          {xtype:'container',itemId: 'save_cancel_box', layout: {type: 'hbox'}, style: {padding: '10px',margin: '10px'}}
         ],
     config: {
    	defaultSettings: {
    	    pi_predecessor_field_name: 'blah-p',
    	    pi_successor_field_name: 'blah'   		
    	}
    },
    
    launch: function() {

    	if (typeof(this.getAppId()) == 'undefined' ) {
    		this.logger.log ('App is not running from within Rally.');
    		this._showExternalSettingsDialog(this.getSettingsFields());
        	this.logger.log('WORKSPACE',this.getContext().getWorkspace().Name);
        	this.logger.log('PROJECT',this.getContext().getProject().Name);
        	this.logger.log('USER', this.getContext().getUser().UserName);
        } 
    	
    	//Add the select button and initial instructions
    	this.down('#portfolio_item_box').add(
    	{
    		xtype: 'rallybutton',
    		id: 'portfolio_item_box_select_button',
    		text: 'Select...',
    		style: {margin: '5px'},
    		scope: this,
    		handler: function()
    		{
    			this._selectPortfolioItems();
    		}
    	});
        this.down('#portfolio_item_box').add(
        		{
        			xtype: 'label',
        			html: '<font color="#808080" size=2><i>Please select a portfolio item.</i></font>',
        			id:'portfolio_item_box_text',
        			style: {margin:'5px'}
        		});
    },
    
    _selectPortfolioItems: function(){
    	//launches the dialog box to select the current portfolio item form 
    	var me = this;
    	Ext.create('Rally.ui.dialog.ChooserDialog',
    			{
    				artifactTypes:['portfolioitem'],
    				autoShow: true,
    				title: 'Choose a Portfolio Item',
    				id: 'portfolio_item_chooser',
    				multliple: false,  //user can only pick 1 item
    				modal: true,
    				scope:this,
    				storeConfig: {  //Need to get the current relationship, so retrieve additional fields
    					fetch: ['ObjectID','Name', 'FormattedID', me._getPredecessorFieldName(), me._getSuccessorFieldName()]
    				},
    				gridConfig: {
    					columns: {
    						items: [{
    							text: 'ID', dataIndex: 'FormattedID'
    						},{
    							text: 'Name', dataIndex: 'Name'
    						}]
    					}
    				},
    				listeners: {
    					artifactChosen: function (selectedRecords){
    						if (selectedRecords == undefined)
    							{
    							Ext.Msg.alert('Chooser', 'Please select a Portfolio Item');
    							return;
    							}
     						me._addRelativeSelectors(selectedRecords);
    					}
    				}
    			});
    },


    _getPredecessorFieldName: function(){
    	return this.getSetting('pi_predecessor_field_name');
    },
    _getSuccessorFieldName: function(){
    	return this.getSetting('pi_successor_field_name');
    },
    _addRelativeSelectors: function(selected_records){
		//This function clears out the existing portfolio item, resets the buttons and loads the relative grids
    	var me = this; 
    	
    	//Clear out all the existing grids, buttons, etc 
		if (me.down('#portfolio_item_box_text')){
			me.down('#portfolio_item_box_text').destroy();
		}
    	me.down('#predecessor_box').removeAll(true);
    	me.down('#successor_box').removeAll(true);
    	me.down('#save_cancel_box').removeAll(true);
    	me.selected_portfolio_item = selected_records;
    	
        me.down('#portfolio_item_box').add(
        		{
        			xtype: 'rallytextfield',
        			value: me._getPortfolioItemDisplayText(selected_records),
        			id:'portfolio_item_box_text',
        			style: {margin: '5px'}
        		});
        
        //_getRelativeStore returns a promise
        this._getRelativeStore(selected_records, me._getPredecessorFieldName())
        	.then({
        		scope: this,
        		success: function(store){
        			var predecessor_store = store; 
        	    	me._addRelativeSelector('#predecessor_box',
        	    								'predecessor_grid',
        	    								me._choosePredecessors, 
        	    								me._removePredecessors, 
        	    								predecessor_store);

        	    	this._getRelativeStore(selected_records, me._getSuccessorFieldName())
        	    		.then({
        	    				success: function(store){
        	    					var successor_store = store; 
         	    					me._addRelativeSelector('#successor_box',
        	        	    								'successor_grid',
        	        	    								me._chooseSuccessors, 
        	        	    								me._removeSuccessors, 
        	        	    								successor_store);
        	    				}
        	    		});
        		}
        	});
    },
    _getRelativeStore: function(selected_record, relative_field_name){
  	 	var deferred = Ext.create('Deft.Deferred');
    	var me = this;
    	var relative_content = selected_record.get(relative_field_name);	

    	this.logger.log ('_getRelativeStore INPUT', relative_field_name, relative_content);

   	 	if (relative_content.length > 0)
   	 	{
   	 		var object_ids = this._getObjectIdsFromRelativeHtml(relative_content);
   	 		if (object_ids.length > 0)
   	 		{
	   	 		var promises = [];
	   	 		Ext.Array.each(object_ids, function(object_id){
	   	 			promises.push(me._loadRelativeStore(object_id));
	   	 		});
	   	 		Deft.Promise.all(promises).then({
	   	 					scope: this,
	   	 					success: function(records) {
	   	 						var record_data = null;
	   	 						Ext.Array.each(records, function(record){
	   	 							console.log('record' , record[0]);
	   	 							if (record[0] != undefined){
	   	 								if (record_data == null){
	   	 									record_data = [];  //initialize this.  We can't do this above becuase it won't render an empty grid correctly if we pass in an empty array
	   	 								}
		   	 							record_data.push(
			   	 								record[0]); //.getData()); //THIS is why my removes weren't working;  
	   	 							}
	   	 						});
	   	 						var store = this._createRelativeStore(record_data);
		   	 			 		deferred.resolve(store);
	  	 					},
	   	 					failure: function(error){
	   	 						this.logger.log('_getRelativeStore failed with error: ',error);
	   	 		   	 			deferred.resolve(this._createRelativeStore());
	  	 					}
	   	 		});
	   	 	}
   	 		else 
   	 			{
  	   	 		deferred.resolve(this._createRelativeStore());
   	 			}
   	 	}
   	 	else
   	 		{
   	 		deferred.resolve(this._createRelativeStore());
   	 		}
   	 	return deferred.promise;
    },
    _createRelativeStore: function(record_data){
    	if (record_data == undefined){
    		record_data = null;
    	}
    	var relative_store = Ext.create('Rally.data.custom.Store', {
			model: 'PortfolioItem',	
    		fetch: ['ObjectID','FormattedID', 'Name', this._getPredecessorFieldName(), this._getSuccessorFieldName()],
					data: record_data,
					pageSize: 25
	 		});   	
    	return (relative_store);
    },
    _loadRelativeStore: function(object_id){
    	 var deferred = Ext.create('Deft.Deferred');
         this.logger.log('_loadRelativeStore - input', object_id);
    	 
 		Ext.create('Rally.data.wsapi.Store',{
			model: 'PortfolioItem',
			fetch: ['ObjectID','FormattedID','Name',this._getPredecessorFieldName(),this._getSuccessorFieldName()],
			filters: {property: 'ObjectID', value:object_id},
			autoLoad: true,
			listeners: {
				scope:this, 
				load: function(store, records){
					console.log('load complete');
					deferred.resolve(records);
				}
			}
		});
 		//TODO what do we do if the load event is never fired? The promise is never resolved or rejected 
 		return deferred.promise; 
        },
    
    _formatRelativeData: function (data_items){
        	var content = '';
        	for (var i=0; i < data_items.length; i++){
        		var id = data_items[i].get('ObjectID');
        		//create the HTML Link 
        		content += '<a id="' + id + '" href="' + Rally.nav.Manager.getDetailUrl(data_items[i]) + '">' + data_items[i].get('FormattedID') + ' - ' + data_items[i].get('Name') + '<br></a>';
        	}
        	this.logger.log('_formatRelativeData returned content:', content);
        	return content;
     },
     
    _getObjectIdsFromRelativeHtml: function(html){
    	
		this.logger.log('_getObjectIdsFromRelativeHtml - input html', html);
		var el = document.createElement( 'div' );
    	el.innerHTML = html;

		var relative_els = el.getElementsByTagName( 'a' ); // Live NodeList of your anchor elements

		var object_ids = [];
		if (relative_els.length > 0){
			for (var i=0; i<relative_els.length; i++){
				if (!isNaN(relative_els[i].id) && (relative_els[i].id.length>0))
				{
					console.log(relative_els[i].id);
					object_ids.push(relative_els[i].id);
				}
				else
				{
					this.logger.log('WARNING: Invalid ObjectID in custom field.  Relative will not be loaded:', relative_els[i].id );
				}
    		}
		}
		this.logger.log('_getObjectIdsFromRelativeHtml - output ids', object_ids, object_ids.length);
		return object_ids;
    },

    /*
     * 
     * Add predecessor and successor grids, add buttons and save\cancel button 
     * 
     */
    _addRelativeSelector: function(container_id, grid_id, add_handler_function, remove_handler_function, relative_store){
    	var me = this;
    	this.down(container_id).removeAll();
     	
    	//Add the grid 
    	this._addRelativeGrid (container_id, relative_store,grid_id);
    	
    	//Add the button
    	this.down(container_id).add({
    			xtype: 'rallybutton',
    			text: '+Add',
    			id: container_id + '_add_button',
        		style: {margin: '5px'},
    			scope: this,
    			handler: add_handler_function
    	});

    	this.down(container_id).add({
    		xtype:'rallybutton',
    		text: 'Remove Selected',
    		id: container_id + '_remove_button',
    		style: {margin: '5px'},
    		scope: this,
    		listeners: {
    			click: remove_handler_function,
    			scope: this
    		}//,
    		//handler: remove_handler_function
    	});

    },
   
    _addRelativeGrid: function(container_id, store, grid_id){
    	
    	var title = 'Successors';
    	if (container_id == '#predecessor_box') {
    		title = 'Predecessors';
    	}
    	
    	this.down(container_id).add({
    		xtype: 'rallygrid',
    		title: title,
    		id:grid_id,
    		store: store,
    		enableEditing: false,
    		enableRanking: false,
    		showRowActionsColumn: false,
    		showPagingToolbar: false,
    		selModel: {
    			selType: 'checkboxmodel', 
    			mode:'MULTI', 
    			itemId: container_id + '_selmodel',
    			listeners: {
    				scope:this,
    				selectionchange: function(selection_model, selected)
    				{
    					//TODO Set button disabled
    				}
    			}
    		},
    		scope:this,
    		columnCfgs: [
    		             {
    		            	 text: 'ID', dataIndex: 'FormattedID', flex:1
    		             },
    		             {
    		            	 text: 'Name', dataIndex: 'Name', flex: 1
    		             },
    		             ]
    	});

    },

    _getPortfolioItemDisplayText: function(pi_record){
    	if (pi_record == null || pi_record == undefined){
    		return 'Not Defined';
    	}
    	return pi_record.data.FormattedID + ' - ' + pi_record.data.Name;
    },

    _chooseSuccessors: function(){
    	var me=this;
    	Ext.create('Rally.ui.dialog.ChooserDialog', {
    	    artifactTypes: ['portfolioitem'],
    	    autoShow: true,
    	    multiple: true,
    	    title: 'Choose Successor Items',
			storeConfig: {
				fetch: ['Name', 'FormattedID', me._getPredecessorFieldName(), me._getSuccessorFieldName()]
			},
    	    scope: this,
    	    listeners: {
    	        artifactChosen: function(selected_records) { 
    	        	me._addSuccessors(selected_records);
    	        },

    	        scope: this
    	    }
		});
    }, 
    _choosePredecessors: function(){
    	var me=this;
    	Ext.create('Rally.ui.dialog.ChooserDialog', {
    	    artifactTypes: ['portfolioitem'],
    	    autoShow: true,
    	    multiple: true,
    	    title: 'Choose Predecessor Items',
			storeConfig: {
				fetch: ['Name', 'FormattedID', me._getPredecessorFieldName(), me._getSuccessorFieldName()]
			},
			scope: this,
			listeners: {
    	        artifactChosen: function(selected_records){
    	        	me._addPredecessors(selected_records);
    	        },
    	        scope:this
    	    }
    	 });
    },
    _appendToRelativeItem: function(selected_records, target_field_name, item_to_append){
    	var deferred = Ext.create('Deft.Deferred');
    	var me = this;	
    	var promises = [];
    	Ext.Array.each(selected_records, function(selected_record){
    		var new_content = me._addToHtml(item_to_append, selected_record.get(target_field_name));
    		promises.push(me._updateRelativeData(selected_record, target_field_name, new_content));
    	});
		Deft.Promise.all(promises).then({
	    	scope:this,
	    	success: function(){
	    		me.logger.log('_appendToRelativeItem SUCCESSFUL');
	    		deferred.resolve();
	    	},
	    	failure: function(){
	    		me.logger.log('_appendToRelativeItem FAILED');
	    		deferred.reject();
	    	}
		});
    	return deferred.promise;
    },		
    
    _addToHtml: function(item_to_add,html){
    	
    	var object_id_to_add = item_to_add.get('ObjectID');
    	var el = document.createElement( 'div' );
    	el.innerHTML = html;

		var relative_els = el.getElementsByTagName( 'a' ); // Live NodeList of your anchor elements

		if (relative_els.length > 0){
			for (var i=0; i<relative_els.length; i++){
				if (!isNaN(relative_els[i].id))
				{
					if (relative_els[i].id == object_id_to_add){
						//don't add again, or maybe we want to remove and add again
						return html;  
					}
				}
			}
		} 		
		html += this._formatRelativeData([item_to_add]);
		return html;
    },

    _updateCurrentItem: function(target_item,grid_id, relative_field_name){
    	//Updates the relative data fields (as defined in the settings) per the state of the current grid (grid_id)
    	var deferred = Ext.create('Deft.Deferred');
    	
        this.logger.log('_updateCurrentItem', target_item, grid_id, relative_field_name);
        
        //need to get existing content from item and make sure that we don't delete anything that is hidden
        var current_html = target_item.get(relative_field_name);
        console.log(current_html);
    	var relative_items = this.down(grid_id).getStore().data.items;
        var relative_content = this._formatRelativeData(relative_items);
        
        this._updateRelativeData(target_item, relative_field_name, relative_content).then({
        	scope: this,
        	success: function(){
        		this.logger.log('_updateCurrentItem SUCCESSFUL');
        		deferred.resolve();
        	},
        	failure: function(){
        		this.logger.log('_updateCurrentItem FAILED');
        		deferred.reject();
        	}
        });
        return deferred;
    },	 	
    
    _stripFromHtml: function(object_id_to_remove,html){
     	var el = document.createElement( 'div' );
    	el.innerHTML = html;
		var relative_els = el.getElementsByTagName( 'a' ); 
		if (relative_els.length > 0){
			for (var i=0; i<relative_els.length; i++){
				if (!isNaN(relative_els[i].id))
				{
					if (relative_els[i].id == object_id_to_remove){
						el.removeChild(relative_els[i]);
					}
				}
			}
			this.logger.log('_stripFromHtml OLD CONTENT', html, 'NEW CONTENT', el.innerHTML);	
			html = el.innerHTML;
		} 		
		return html;
    },
    
    _updateRelativeData: function(target_item, target_field, update_content){
    	var deferred = Ext.create('Deft.Deferred');
    	
    	//Updates the target model with the new content 
    	target_item.set(target_field, update_content);
    	target_item.save({
    		scope: this,
    		callback: function(record, operation){
    			console.log('OPERATION',operation);
    			if (operation.wasSuccessful())
    			{
					this.logger.log('Update Successful', target_item.get('ObjectID'), target_field, update_content);
					deferred.resolve();
				}
				else 
				{
					this.logger.log('Update Failed', target_item.get('ObjectID'), target_field, update_content);
					deferred.reject(operation.Errors);
				}
    		}
    	});
    	return deferred;
    },
    
    
   _removeFromRelativeItem: function(selected_record, object_id_to_remove,remove_from_field){
    	var deferred = Ext.create('Deft.Deferred');
    	var me= this;

    	var orig_content = selected_record.get(remove_from_field);
    	var new_content = me._stripFromHtml(object_id_to_remove, orig_content); 
		
		this._updateRelativeData(selected_record, remove_from_field, new_content).then({
			scope:this,
			success: function(){
				deferred.resolve();
			},
			failure: function(){
				deferred.reject();
			}
		});
    	return deferred.promise; 
    },
    
	_removeFromSelectedRelativeItems: function(selected_records, remove_from_field, item_to_remove){
    	var deferred = Ext.create('Deft.Deferred');
    	var me = this;	
    	
        var object_id_to_remove = item_to_remove.get('ObjectID');

        var promises = [];
	 	Ext.Array.each(selected_records, function(selected_record){
 			promises.push( me._removeFromRelativeItem(selected_record,object_id_to_remove,remove_from_field));
//	 		promises.push(function() {return me._removeFromRelativeItem(selected_record,object_id_to_remove,remove_from_field);});
	 		});
	 		Deft.Promise.all(promises).then({
	 					scope: this,
	 					success: function(){
	 						console.log('_removeFromRelativeItem Return Success');
	 						deferred.resolve();
	 					},
	 					failure: function(){
	 						me.logger.log('_removeFromRelativeItem Relatives failed to save');
	 						deferred.reject('Relatives failed to save');
	 					}
	 		});
    	return deferred;
    },
   
  	
    /*
     * 
     * Removing relatives from the current portfolio item
     * 
     */
    _removeRelatives: function(grid_id){
    	var me = this;
    	var grid = this.down(grid_id);
    	
    	var selected_records = grid.selModel.getSelection();
    	if (selected_records && selected_records.length > 0 ){
	   		if (grid_id == '#successor_grid')
	       	{
	  		 		remove_field_from_relative = this._getPredecessorFieldName();
	   		 		remove_field_from_me = this._getSuccessorFieldName();
	       	}
	       	else
	       	{
	   		       remove_field_from_relative = this._getSuccessorFieldName();     
	   		       remove_field_from_me = this._getPredecessorFieldName();
	       	}
		 	var original_content = this._preserveOriginalContent(selected_records,remove_field_from_relative);	
	   		this._removeFromSelectedRelativeItems(selected_records, remove_field_from_relative, this.selected_portfolio_item ).then({
	   			scope:this,
	        	success: function() {
	        		this.logger.log('Promise returned.  Portfolio item successors and predecessors updated successfully.');
	            	//this._commitEdits(selected_records);
	        		grid.getStore().remove(selected_records);
	            	this._updateCurrentItem(this.selected_portfolio_item,grid_id, remove_field_from_me).then({
	            		scope: this,
	            		success: function(){
	            			this.logger.log('Success updating current item.');
	            		},
	            		failure:function() {
	    	       			var msg = 'Update of current item failed.  Rolling back changes to related items.';
    	  	       			alert(msg);
	       	       			this.logger.log(msg);
	    	        		this._restoreOriginalContent(selected_records,remove_field_from_relative,original_content );
	            		}
	            	});
	        	},
	        	failure: function(){
	       			var msg = 'Removal of related items failed.  Rolling back changes to related items.';
   	       			alert(msg);
   	       			this.logger.log(msg);
	        		this._restoreOriginalContent(selected_records,remove_field_from_relative,original_content );
	        	}
	   		});

    	}
    },  

    _removeSuccessors: function(){
    	this._removeRelatives('#successor_grid');
    },
    _removePredecessors: function(){
    	this._removeRelatives('#predecessor_grid');
    },
    _addSuccessors: function(selected_records){
    	var grid = this.down('#successor_grid');
       	//since we are adding predecessors, we only need to preserve predecessor fields for the selected items
    	var original_content = this._preserveOriginalContent(selected_records, this._getPredecessorFieldName());
    	
    	grid.getStore().add(selected_records);  

    	this._appendToRelativeItem(selected_records,this._getPredecessorFieldName(),this.selected_portfolio_item).then({
       		scope: this,
       		success: function(){
       			this._updateCurrentItem(this.selected_portfolio_item,'#successor_grid', this._getSuccessorFieldName()).then({
       	       		scope:this,
       	       		success: function(){
       	       			this.logger.log('Updates successful.');
       	       		},
       	       		failure: function(){
       	       			var msg = 'Update of current portfolio item failed.  Rolling back changes to related items.';
       	       			alert(msg);
       	       			this.logger.log(msg);
       	      		    this._restoreOriginalContent(selected_records, this._getPredecessorFieldName(), original_content);
       	       		}
       	       	});
       		},
       		failure: function() {
	       			var msg = 'Update of related items failed.  Rolling back changes to related items.';
   	       			alert(msg);
   	       			this.logger.log(msg);
   	       			this._restoreOriginalContent(selected_records, this._getPredecessorFieldName(), original_content);
       		}
       	});
    	//this._updateCurrentItem(this.selected_portfolio_item,'#successor_grid', this._getSuccessorFieldName());
    },
    _addPredecessors: function(selected_records){
    	var grid = this.down('#predecessor_grid');
    	
    	//since we are adding predecessors, we only need to preserve successor fields for the selected items
    	var original_content = this._preserveOriginalContent(selected_records, this._getSuccessorFieldName());
    	
    	grid.getStore().add(selected_records);
       	this._appendToRelativeItem(selected_records,this._getSuccessorFieldName(),this.selected_portfolio_item).then({
       		scope: this,
       		success: function(){
       	       	this._updateCurrentItem(this.selected_portfolio_item,'#predecessor_grid', this._getPredecessorFieldName()).then({
       	       		scope: this,
       	       		success: function(){
       	       			this.logger.log('Updates successful.');
       	       		},
       	       		failure: function(){
       	       			var msg = 'Update of current portfolio item failed.  Rolling back changes to related items.';
       	       			alert(msg);
       	       			this.logger.log(msg);
       	       			this._restoreOriginalContent(selected_records, this._getSuccessorFieldName(), original_content);
       	       		}
       	       	});
       		},
       		failure: function() {
       			var msg = 'Update of related items failed.  Rolling back changes to related items.';
       			alert(msg);
       			this.logger.log(msg);
       	    	this._restoreOriginalContent(selected_records, this._getSuccessorFieldName(), original_content);
       		}
       	});
    },
    _preserveOriginalContent: function(selected_records, field_to_preserve){
    	//For rollback purposes, store the original field values for relatives
    	//I don't think this is needed for the current item since it is the last in the chain.  If it 
    	//fails to update, we don't need to roll it back.  

    	var original_content = [];  
    	Ext.Array.each(selected_records, function(selected_record){
    		var key =   selected_record.get('ObjectID');
    		var value = selected_record.get(field_to_preserve);
    		original_content[key]=value;
    	  });
    	return original_content; 
    },

    _restoreOriginalContent: function(selected_records, field_to_restore, original_content){
    	
    	Ext.Array.each(selected_records, function(selected_record){
    		var id = selected_record.get('ObjectID');
    		if (selected_record.get(field_to_restore) != original_content[id]){ //only restore if it changed;  
    			//Since we can determine whether it changed without a trip to the store, we might as well
	    		this._updateRelativeData(selected_record, field_to_restore, original_content[id]).then({
	    				success: function(){
	    					//do nothing, we're just glad the rollback worked
	    				},
	    				failure: function() {
	    					//keep going, this could have failed due to permissions error, etch.  We are most concerned with restoring
	    					//what was originally there
	    				}
	    		});
    		}
    	});
    },

 /*
  * 
  * Settings related code below here 
  * 
  */
//Overrides getSettingsFields in Rally.app.App
getSettingsFields: function() {

    var _chooseOnlyTextFields = function(field){
        var should_show_field = true;

        if ( field.hidden ) {
            should_show_field = false;
        }
        if ( field.attributeDefinition ) {
            var type = field.attributeDefinition.AttributeType;
            if ( type != "TEXT"  ) {
                should_show_field = false;
            }
        } else {
            should_show_field = false;
        }

        return should_show_field;
    };
	
    return [{
        name: 'pi_predecessor_field_name',
        xtype: 'rallyfieldcombobox',
        model: 'PortfolioItem',
        fieldLabel: 'Portfolio Item Predecessor Field',
  //      width: 300,
        labelWidth: 200,
        _isNotHidden: _chooseOnlyTextFields,
        value: this._getPredecessorFieldName(),
       //valueField: 'name',
        readyEvent: 'ready' //event fired to signify readiness
    },
    {
        name: 'pi_successor_field_name',
        xtype: 'rallyfieldcombobox',
        model: 'PortfolioItem',
        fieldLabel: 'Portfolio Item Successor Field',
        _isNotHidden: _chooseOnlyTextFields,
    //    width: 300,
        labelWidth: 200,
        value: this._getSuccessorFieldName(),
        //valueField: 'name',
        readyEvent: 'ready' //event fired to signify readiness
    }];
},
// ONLY FOR RUNNING EXTERNALLY
_showExternalSettingsDialog: function(fields){
	var me = this;
    if ( this.settings_dialog ) { this.settings_dialog.destroy(); }
    this.settings_dialog = Ext.create('Rally.ui.dialog.Dialog', {
         autoShow: false,
         draggable: true,
         width: 400,
         title: 'Settings',
         scope: this,
         buttons: [{ 
            text: 'OK',

            handler: function(cmp){
                var settings = {};
                Ext.Array.each(fields,function(field){
                	me.logger.log(field.name, '=',cmp.up('rallydialog').down('[name="' + field.name + '"]').getValue() );
                	settings[field.name] = cmp.up('rallydialog').down('[name="' + field.name + '"]').getValue();
                });
                me.settings = settings;
                cmp.up('rallydialog').destroy();
            }
        }],
         items: [
            {xtype:'container',html: "&nbsp;", padding: 5, margin: 5},
            {xtype:'container',itemId:'field_box', padding: 5, margin: 5}]
     });
     Ext.Array.each(fields,function(field){
    	me.logger.log('Add: ', field.name, field.value); 
        me.settings_dialog.down('#field_box').add(field);
     });
     this.settings_dialog.show();
}
});   





            
               Rally.launchApp('CustomApp', {
                   name: 'pi-dependency-textfield'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width:5%;
}
    </style>

</head>
<body></body>
</html>